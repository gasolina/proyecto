#include <iostream>
#include<conio.h>
#include<stdlib.h>
#include <stdio.h>
#include<string.h>
using namespace std;
#define fil 50
//estructuras
struct venta{
	int idventa;
	char fecha[10];
	int idprod;
	float cantidad;
	float preciototal;
	int idbomba;
	int idauto;
	char estado;
};
struct automotor{
	int idauto;
	char placa[10];
	int idcliente;
	char estado;
};
struct cliente{
int idcliente;
char nombre[30];
char email[30];
char telefono[12];
char nit[10];
char estado;
};
struct vendedor{
int idvendedor;
char nombre[30];
char email[30];
char telefono[12];
char estado;
};
struct producto{
int idprod;
char nombre[30];
float preciounit;
float stock;
char estado;
};
struct compras{
int idcompra;
char fecha[10];
int idprod;
float cantidad;
float preciototal;
};
struct bomba{
int idbomba;
char descripcion[30];
int idprod;
int idvendedor;
};
struct fechas{
int dia;
int mes;
int anho;
}; //contiene cmapos dia mes y anho
//funciones
bool validarplaca(char placa[]);//listo
int buscaridplaca(char placa[]);//listo
int generarid(int tipo);//listo
void fecha(char fecha[10] );//listo
bool menuventas(venta &v);//llena el preciototal,idprod,idbomba,cantidad//listo
void anhadirventa(venta v);//listo
void barrafecha(char fecha[10]);//listo
int validarentero();//listo
float validarfloat();//listo(revisar por si hubiera mas de un punto)
vendedor buscarvendedor(int id);//listo
producto buscarproducto(int id);//listo
bool existenciavendedor();//listo
bool menucompras(compras &c);//listo
void anhadircompra(compras c);//listo
bool existenciaproducto();//listo
void rankingclientes();//listo
void convertirfecha(fechas &f,char fecha[10]);//listo ,convierte el char fecha a la estructura fechas para poder comparar
bool existenciacliente();//listo
int calcularventasporcliente(int id,fechas f1,fechas f2);//listo
void ordenarmatriz(int mat[fil][2],int n);//listo
void buscarnombrecliente(int id,char nombre[30]);//listo
int compararfechas(fechas f1,fechas f2);//listo

//desarrollo
void vender()
{venta v;char placa[12];int op;bool z;
   do{op=1;
        do{ cout<<"\ningrese placa";
			fflush(stdin);
			gets(placa);}while(validarplaca(placa)==false);
			v.idauto=buscaridplaca(placa);
			if(v.idauto>0)
			{
				v.idventa=generarid(7);
				fecha(v.fecha);
				barrafecha(v.fecha);
				z=menuventas(v);
				if(z==true)
				{ 
					cout<<"\n esta seguro de sus datos?";
					do{cout<"\n1.-si\n2.-vovler a intentar";
					cin>>op;}while(op!=1&&op!=2);
					if(op==1)
					{anhadirventa(v);cout<<"\nventa registrada";getch();}
				}
				else{
				do{cout<<"\nquiere volver a intentarlo?";
				    cout<<"\n1.-NO\n2.-SI";
					cin>>op;}while(op!=1&&op!=2);
				}
			}
			else{
			cout<<"\n placa no registrada, vaya a registrarlo";
			do{cout<<"\n1.-volver a menu\n2.-volver a intentar";
			cin>>op;}while(op!=1&&op!=2);
			}
   }while(op==2);
}
void comprar()
	{compras c;bool z;int op;
do{       op=1; 
	fecha(c.fecha);
			barrafecha(c.fecha);
			c.idcompra=generarid(6);
			z=menucompras(c);
			if(z==true)
			{
				cout<<"\n esta seguro de sus datos?";
							do{cout<"\n1.-si\n2.-vovler a intentar";
							cin>>op;}while(op!=1&&op!=2);
							if(op==1)
							{anhadircompra(c);cout<<"\ncompra registrada";getch();}
			}
			else{   
						do{cout<<"\nquiere volver a intentarlo?";
							cout<<"\n1.-volver a menu \n2.-SI";
							cin>>op;}while(op!=1&&op!=2);
				}
}while(op==2);
}

//desarrollo de funciones
void barrafecha(char fecha[10])
{char aux[10];
  aux[0]=fecha[0];
  aux[1]=fecha[1];
  aux[2]='/';
  aux[3]=fecha[2];
  aux[4]=fecha[3];
  aux[5]='/';
  aux[6]=fecha[4];
  aux[7]=fecha[5];
  aux[8]=fecha[6];
  aux[9]=fecha[7];
  
}
void fecha(char fecha[]){
	int day, month, year,fechatotal,band=1;
	char fechaaux[10];

do{band=1;
	cout << "Ingrese el d\241a: "; cin >> day; //Día 
	cout << "\nIngrese el mes: "; cin >> month; //Mes 
	cout << "\nIngrese el a\244o: "; cin >> year; //Año 

	if ((month == 2) && !((year % 4 == 0 && year % 100 != 0) || (year % 400 == 0)) && ((day > 28) || (day <= 0)))
	{cout << "\n\nFecha incorrecta: Este mes solo tiene 28 d\241as"; band=2;}

	else
	{
		if ((month == 2) && ((year % 4 == 0 && year % 100 != 0) || (year % 400 == 0)) && ((day > 29) || (day <= 0)))
		{cout << "\n\nFecha incorrecta: Este mes solo tiene 29 d\241as"; band=2;}

	


			else
			{
				if (((month == 1) || (month == 3) || (month == 5) || (month == 7) || (month == 8) || (month == 10) || (month == 12)) && ((day > 31) || (day <= 0)))
				{cout << "\n\nFecha incorrecta: Este mes solo tiene 31 d\241as"; band=2;}

				else
				{
					if (((month == 4) || (month == 6) || (month == 9) || (month == 11)) && ((day > 30) || (day <= 0)))
					{cout << "\n\nFecha incorrecta: Este mes solo tiene 30 d\241as"; band=2;}

					else
					{
						if ((month > 12) || (month <= 0))
						{cout << "\n\nFecha incorrecta: El a\244o solo tiene 12 meses"; band=2;}
						else{
							if(year<2000||year>2100)
							{cout << "\n\nFecha incorrecta"; band=2;}
						else{
							if (day < 10 && month < 10)
								{
							fechatotal=year+month*pow(10,4)+day*pow(10,6);
							fecha[0]='0';
							itoa(fechatotal,fechaaux,10);
							strcat(fecha,fechaaux);
							     
							     }
							else
							{
								if (day < 10 && month >= 10)
									{
								        fechatotal=year+month*pow(10,4)+day*pow(10,6);
							fecha[0]='0';
							itoa(fechatotal,fechaaux,10);
							strcat(fecha,fechaaux);
								    }


								else
								{
									  fechatotal=year+month*pow(10,4)+day*pow(10,6);
							            itoa(fechatotal,fecha,10);

								}
							}
						}
					}
				}
			}
		}
	}
}while(band==2);

}
bool validarplaca(char placa[])
{
	int i=0;
	if(strlen(placa)!=7)
	{cout<<"error en placa";getch();
		return false;
    }
	else {
				for(i=0;i<4;i++)
				{
					if(placa[i]!='0'&&placa[i]!='1'&&placa[i]!='2'&&placa[i]!='3'&&placa[i]!='4'&&placa[i]!='5'&&placa[i]!='6'&&placa[i]!='7'&&placa[i]!='8'&&placa[i]!='9')
					{cout<<"error en placa";getch();
						return false;
					}     
				}
				for(i=i;i<7;i++)
				{
					if(placa[i]<'A'||placa[i]>'Z')
					{cout<<"error en placa";getch();return false;}
				}
	     }
	return true;
}
int buscaridplaca(char placa[])
{
	automotor A;
	FILE *ptr=fopen("Automotor.dat","rb");
	if(ptr!=NULL)
	{
		fread(&A,sizeof(A),1,ptr);
		while(feof(ptr)==false)
		{
			if(strcmp(A.placa,placa)==0&& A.estado=='S')
			{fclose(ptr);
				return A.idauto;
			}
			fread(&A,sizeof(A),1,ptr);
		}fclose(ptr);
		return (-1);
	}
	else{fclose(ptr);
	cout<<"no existe el archivo";
	}
}
int generarid(int tipo){
	FILE *ptr;venta V;
	switch(tipo){
	case 1:
		cliente C;
		ptr=fopen("Clientes.dat","rb");
		fread(&V,sizeof(C),1,ptr);
		if(feof(ptr)==true)
		{    fclose(ptr);
		C.idcliente=1;return C.idcliente;
			
		}
		else{
			fseek(ptr,-sizeof(C),SEEK_END);
			fread(&V,sizeof(C),1,ptr);
			fclose(ptr);
			C.idcliente++;return C.idcliente;
		}
		break;
	case 2:
		vendedor ven;
		ptr=fopen("Vendedor.dat","rb");
		fread(&ven,sizeof(ven),1,ptr);
		if(feof(ptr)==true)
		{    fclose(ptr);
		ven.idvendedor=1;return ven.idvendedor ;
			
		}
		else{
			fseek(ptr,-sizeof(ven),SEEK_END);
			fread(&V,sizeof(ven),1,ptr);
			fclose(ptr);
			ven.idvendedor++;return ven.idvendedor;
		}
		break;
	case 3:
		producto p;
		ptr=fopen("Vendedor.dat","rb");
		fread(&p,sizeof(p),1,ptr);
		if(feof(ptr)==true)
		{    fclose(ptr);
		p.idprod=1;return p.idprod ;
			
		}
		else{
			fseek(ptr,-sizeof(p),SEEK_END);
			fread(&p,sizeof(p),1,ptr);
			fclose(ptr);
			p.idprod++;return p.idprod;
		}
		break;
	case 4:
	automotor a;
		ptr=fopen("Automotor.dat","rb");
		fread(&a,sizeof(a),1,ptr);
		if(feof(ptr)==true)
		{    fclose(ptr);
		a.idauto=1;return a.idauto ;
			
		}
		else{
			fseek(ptr,-sizeof(a),SEEK_END);
			fread(&a,sizeof(a),1,ptr);
			fclose(ptr);
			a.idauto++;return a.idauto;
		}
		break;
	case 5:
		bomba b;
				ptr=fopen("Bomba.dat","rb");
		fread(&b,sizeof(b),1,ptr);
		if(feof(ptr)==true)
		{    fclose(ptr);
		b.idbomba=1;return b.idbomba ;
			
		}
		else{
			fseek(ptr,-sizeof(b),SEEK_END);
			fread(&b,sizeof(b),1,ptr);
			fclose(ptr);
			b.idbomba++;return b.idbomba;
		}
		break;
	case 6:
		compras com;
	    ptr=fopen("Compras.dat","rb");
		fread(&com,sizeof(com),1,ptr);
		if(feof(ptr)==true)
		{    fclose(ptr);
		com.idcompra=1;return com.idcompra ;
			
		}
		else{
			fseek(ptr,-sizeof(com),SEEK_END);
			fread(&com,sizeof(com),1,ptr);
			fclose(ptr);
			com.idcompra++;return com.idcompra;
		}
		break;
	case 7:
		ptr=fopen("Ventas.dat","rb");
		fread(&V,sizeof(V),1,ptr);
		if(feof(ptr)==true)
		{    fclose(ptr);
			V.idventa=1;return V.idventa;
			
		}
		else{
			fseek(ptr,-sizeof(V),SEEK_END);
			fread(&V,sizeof(V),1,ptr);
			fclose(ptr);
			V.idventa++;return V.idventa;
		}
		break;
	}

}

bool menuventas(venta &v){
	vendedor ven;producto prod;bomba bom;int cont=1;int op;
	FILE *ptr=fopen("Bomba.dat","rb");
	do{if(ptr!=NULL&&existenciavendedor()==true)
	{fread(&bom,sizeof(bom),1,ptr);
	  cout<<"\nseleccione que vendedor es usted";
	  cout<<"\n  vendedor";
	  cout.width(20);
	  cout<<"producto";
	  cout.width(20);
	  cout<<"precio unitario"<<endl;
	  while(feof(ptr)==false)
	  {ven=buscarvendedor(bom.idvendedor);
	  prod=buscarproducto(bom.idprod);
		  if(ven.estado=='S')
		 { cout<<cont<<".-"<<ven.nombre;
		  cout.width(20);
		  cout<<prod.nombre;
		  cout.width(20);
		  cout<<prod.preciounit<<endl;
		  fread(&bom,sizeof(bom),1,ptr);
		  }cont++;
	  }
	  cout<<"\n0.-salir";
	  op=validarentero();
	  if(op!=0)
	  {fseek(ptr,(cont-1)*sizeof(bom),SEEK_SET);
	    if(feof(ptr)==false)
		{ fread(&bom,sizeof(bom),1,ptr);fclose(ptr);
		v.idbomba=bom.idbomba;
			prod=buscarproducto(bom.idprod);
			do{cout<<"ingrese la cantidad a vender";
			v.cantidad=validarfloat();}while(v.cantidad>prod.stock||v.cantidad<0);
			v.preciototal=v.cantidad*prod.preciounit;
			cout<<"\n el precio total sera "<<v.preciototal<<endl;return true;
		}
		else{
		
			cout<<"no existe el registro seleccionado";
			op=-5;fclose(ptr);
		}

	  }
	}
	else{
	cout<"\nno existe ningun vendedor registrado";fclose(ptr);return false;
	getch();
	}
	}
	while(op==-5);

}
void anhadirventa(venta v)
{
	int band = 0;
	do{
		band = 0;
		FILE *ptr = fopen("Ventas.dat", "ab");

		if (ptr != NULL)
		{
			fwrite(&v, sizeof(v), 1, ptr);
			fclose(ptr);
		}
		else
		{
			ptr = fopen("Ventas.dat", "wb");
			fclose(ptr);
			band = -1;

		}
	} while (band == -1);
}
int validarentero()
{
	int r, i; bool k;
	char num[12];
	do{
		do{
			cout << "\ningrese numero: ";
			gets_s(num);
		} while (strlen(num) == 0);
		i = 0; k = true;
		if (num[0] == '-')
		{
			i++;
			if (strlen(num) == 1)
				k = false;
		}
		while (i<strlen(num))
		{
			if ((num[i] != '0') && (num[i] != '1') && (num[i] != '2') && (num[i] != '3') && (num[i] != '4') && (num[i] != '5') && (num[i] != '6') && (num[i] != '7') && (num[i] != '8') && (num[i] != '9'))
			{
				k = false; break;
			}
			i++;
		}
		if (k == false){ cout << "ERROR FATAL : DATO NO NUMERICO"; }
	} while (k == false);
	r = atoi(num);

	return(r);
}
float validarfloat()
{
	float r;int i; bool k;
	char num[12];
	do{
		do{
			cout << "\ningrese numero: ";
			gets_s(num);
		} while (strlen(num) == 0);
		i = 0; k = true;
		if(num[0]=='.')
		     {k=false;}
		if (num[0] == '-')
		{  
			i++;
			if (strlen(num) == 1)
				k = false;
		}
		while (i<strlen(num))
		{
			if ((num[i]!='.')&&(num[i] != '0') && (num[i] != '1') && (num[i] != '2') && (num[i] != '3') && (num[i] != '4') && (num[i] != '5') && (num[i] != '6') && (num[i] != '7') && (num[i] != '8') && (num[i] != '9'))
			{
				k = false; break;
			}
			i++;
		}
		if (k == false){ cout << "ERROR FATAL : DATO NO NUMERICO"; }
	} while (k == false);
	r = atof(num);

	return(r);
}
vendedor buscarvendedor(int id)
{vendedor v;

	FILE *ptr=fopen("Vendedor.dat","rb");
    fread(&v,sizeof(v),1,ptr);
	while(feof(ptr)==false)
	 {
		 if(v.idvendedor==id)
		 {fclose(ptr);
			 return v;
		 }
	}
}
producto buscarproducto(int id)
{producto p;

	FILE *ptr=fopen("Producto.dat","rb");
    fread(&p,sizeof(p),1,ptr);
	while(feof(ptr)==false)
	 {
		 if(p.idprod==id)
		 {fclose(ptr);
			 return p;
		 }
	}
}
bool existenciavendedor()
{vendedor v;
	FILE *ptr=fopen("Vendedor.dat","rb");
	fread(&v,sizeof(v),1,ptr);
	while(feof(ptr)==false)
	{
		if(v.estado=='S')
		{fclose(ptr);
			return true;}

	}
	fclose(ptr);
	return false;

}
bool menucompras(compras &c)
{producto p;int cont=1,op;
   FILE *ptr=fopen("Producto.dat","rb");
	do{ 
   if(ptr!=NULL&&existenciaproducto()==true)
	   {
		   fread(&p,sizeof(p),1,ptr);
		   cout<<"\n seleccione su producto";
		   cout<<"\nproducto";
		   cout.width(20);
		   cout<<"stock"<<endl;
		   while(feof(ptr)==false)
		   {
			   cout<<cont<<".-";
			   cout<<p.nombre;
			   cout.width(20);
			   cout<<p.stock;
			   cout<<endl;
			   cont++;
			   fread(&p,sizeof(p),1,ptr);
		   }
		   cout<<"\n0.-salir";
		   op=validarentero();
		   if(op!=0)
		   {
			fseek(ptr,(cont-1)*sizeof(p),SEEK_SET);
			if(feof(ptr)==false)
			{ fread(&p,sizeof(p),1,ptr);fclose(ptr);
			c.idprod=p.idprod;
			do{cout<<"\n que cantidad comprara?";
			c.cantidad=validarfloat();}while(c.cantidad<0);
			cout<<"\n cuanto es el precio total de la compra";
			c.preciototal=validarfloat();return true;
			}
			else{
			cout<<"no existe el registro seleccionado";
				op=-5;fclose(ptr);
			}
		   }
	   }
	   else{
		 cout<<"\n no existe producto registrado,primero registrar";fclose(ptr);return false;
		 getch();
	   }
	}while(op==-5);
}
void anhadircompra(compras c)
{
	FILE *ptr=fopen("Compras.dat","ab");
	fwrite(&c,sizeof(c),1,ptr);
	fclose(ptr);
}
bool existenciaproducto()
{producto p;
	FILE *ptr=fopen("Producto.dat","rb");
	fread(&p,sizeof(p),1,ptr);
	while(feof(ptr)==false)
	{
		if(p.estado=='S')
		{fclose(ptr);
			return true;}

	}
	fclose(ptr);
	return false;

}
void rankingclientes()
{char fecha1[10],fecha2[10];cliente c;int mat[fil][2],n=0;char nombre[30];
  fechas f1,f2;
	cout<<"\ningrese fecha 1";
	fecha(fecha1);
	cout<<"\ningrese fecha 2";
	fecha(fecha2);
	convertirfecha(f1,fecha1);
	convertirfecha(f2,fecha2);
	FILE *ptr=fopen("Cliente.dat","rb");
	if(ptr!=NULL&&existenciacliente()==true)
	{  fread(&c,sizeof(c),1,ptr);
       while(feof(ptr)==false)
	   {  if(c.estado=='S')
	        {
				mat[n][0]=c.idcliente;
           mat[n][1]=calcularventasporcliente(c.idcliente,f1,f2);
		   n++;
	        }
	      fread(&c,sizeof(c),1,ptr);
	   }
		   fclose(ptr);

		   ordenarmatriz(mat,n);
		cout<<endl<<"---------TOP CLIENTES---------"<<endl;
		cout<<"CLIENTE";
			cout.width(20);
			cout<<"COMPRAS TOTALES"<<endl;
		for( int i =0;i<n;i++)
		{
			buscarnombrecliente(mat[i][0],nombre);//busca nombre del cliente y lo guarda en char nombre
			cout<<nombre;
			cout.width(20);
			cout<<mat[i][1]<<endl;
	       getch();
		}
	}
	else
	{
		cout<<"\n no existe clientes registrados";
		getch();fclose(ptr);
	}
	
}
int compararfechas(fechas f1,fechas f2)
{
	if(f1.anho<f2.anho)
	{
		return 1;
	}
	else
	{
		if(f1.anho>f2.anho)
		{
			return -1;
		}
		else
		{
			if(f1.anho==f2.anho)
			{
				if(f1.mes<f2.mes)
				{
					return 1;
				}
				else
				{
					if(f1.mes>f2.mes)
						return -1;
					else
					{
						if(f1.mes==f2.mes)
						{
							if(f1.dia<f2.dia)
							{
								return 1;
							}
							else
							{
								if(f1.dia>f2.dia)
									return -1;
								else
									return 0;
							}
						}	
					}
				}
			}	
		}
	}
}
void convertirfecha(fechas &f,char fecha[10])
{char dia[2],mes[2],anho[4];
   dia[0]=fecha[0];
   dia [1]=fecha[1];
   mes[0]= fecha[2];
   mes[1]=fecha[3];
   anho[0]=fecha[4];
   anho[1]=fecha[5];
   anho[2]=fecha[6];
   anho[3]=fecha[7];
   f.dia=atoi(dia);
   f.mes=atoi(mes);
   f.anho=atoi(anho);
}
bool existenciacliente()
{cliente c;
FILE *ptr=fopen("Cliente","rb");
	fread(&c,sizeof(c),1,ptr);
	while(feof(ptr)==false)
	{
		if(c.estado=='S')
		{fclose(ptr);
			return true;}

	}
	fclose(ptr);
	return false;

}
int calcularventasporcliente(int id,fechas f1,fechas f2)
{int s=0;automotor a;venta v;
	FILE *ptr=fopen("Automotor","rb");
	fread(&a,sizeof(a),1,ptr);
	while(feof(ptr)==false)
	{
		if(a.idcliente==id&&a.estado=='S')
		{
             FILE *ptr2=fopen("Ventas.dat","rb");
			 if(ptr!=NULL)
			 {
				 fread(&v,sizeof(v),1,ptr2);
				 while(feof(ptr)==false)
				 {
					 if(a.idauto==v.idauto&&v.estado=='S')
					 {
						 s=s+v.preciototal;
					 }
					 fread(&v,sizeof(v),1,ptr2);
				 }
				 fclose(ptr2);
			 }
			 else
			 { fclose(ptr);fclose(ptr2);
				 return 0;//retorno cero porque no hay registros de ventas entonces nadie compro nada
			 }
		}
	}fclose(ptr);return s;
	
}
void ordenarmatriz(int mat[fil][2],int n)
{int aux;
	for(int i=0;i<(n-1);i++)
	{
		for(int j=i;j<n;j++)
		{
			if(mat[i][1]<mat[j][1])
			{
				aux=mat[i][1];
				mat[i][1]=mat[j][1];
				mat[j][i]=aux;
			}
		}
	}
}
void buscarnombrecliente(int id,char nombre[30])
{cliente c;
	FILE *ptr=fopen("Cliente.dat","rb");
	fread(&c,sizeof(c),1,ptr);
	while(feof(ptr)==false)
	{
		if(c.idcliente==id)
		{
			strcpy(nombre,c.nombre);
		}

	}
	fclose(ptr);
}
